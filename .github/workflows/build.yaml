name: CI & Build

on:
  push:
    branches:
      - "master"
      - "main"
    tags:
      - "v*"
  pull_request:
    branches:
      - "master"
      - "main"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # CI job - runs on all PRs and pushes
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy, rustfmt

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features

      - name: Build
        run: cargo build --release

      - name: Run tests
        run: cargo test --lib --bins

  # Docker build and test job - validates the image works
  docker-test:
    runs-on: ubuntu-latest
    needs: ci
    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: task_runner_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -f Dockerfile.full -t task-runner:test .

      - name: Start container
        run: |
          docker run -d --name task-runner-test \
            --network host \
            -e DATABASE_URL="postgres://test:test@localhost:5432/task_runner_test" \
            -e HOST_URL="http://localhost:4000" \
            -e PORT=4000 \
            task-runner:test

          # Wait for container to be ready
          echo "Waiting for server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:4000/health > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Server failed to start"
              docker logs task-runner-test
              exit 1
            fi
            sleep 1
          done

      - name: Test health endpoint
        run: |
          response=$(curl -s http://localhost:4000/health)
          echo "Health response: $response"
          echo "$response" | grep -q '"status":"ok"' || (echo "Health check failed" && exit 1)

      - name: Test ready endpoint
        run: |
          response=$(curl -s http://localhost:4000/ready)
          echo "Ready response: $response"
          echo "$response" | grep -q '"status":"ready"' || (echo "Ready check failed" && exit 1)

      - name: Test task list endpoint
        run: |
          response=$(curl -s -w "\n%{http_code}" http://localhost:4000/task)
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "Task list response ($http_code): $body"
          [ "$http_code" = "200" ] || (echo "Task list failed with code $http_code" && exit 1)

      - name: Test task creation
        run: |
          response=$(curl -s -w "\n%{http_code}" -X POST http://localhost:4000/task \
            -H "Content-Type: application/json" \
            -H "X-Requester: github-ci" \
            -d '[{"id": "test-1", "name": "CI Test Task", "kind": "test", "params": {}}]')
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "Task creation response ($http_code): $body"
          [ "$http_code" = "201" ] || (echo "Task creation failed with code $http_code" && exit 1)

      - name: Cleanup
        if: always()
        run: |
          docker logs task-runner-test || true
          docker stop task-runner-test || true
          docker rm task-runner-test || true

  # Docker build and push job - only on master/main push or tags
  docker:
    runs-on: ubuntu-latest
    needs: [ci, docker-test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: plawn/task-runner
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main' }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          file: Dockerfile.full
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
